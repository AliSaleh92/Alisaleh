<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AliW | Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù…ÙŠ ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ÙŠ</title>
<link href="https://fonts.googleapis.com/css?family=Tajawal:600,900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
:root {
  --bg-main:#181922;--bg-side:#232435;--bg-task:#232332;--txt-main:#fff;--txt-sub:#aaa;
  --accent:#43b3fa;--card-space:#202030;--prio-high:#ef4444;--prio-med:#fbbf24;--prio-low:#42a5f5;
  --project-colors:#43b3fa,#ef4444,#fb8c00,#7d21ce,#01bc82,#f74d89,#f28021,#3d74ff,#8f36c9,#41d6c3;
}
body{background:var(--bg-main);color:var(--txt-main);font-family:'Tajawal',Arial,sans-serif;margin:0;}
.header-app{display:flex;align-items:center;justify-content:space-between;background:var(--bg-side);padding:20px 22px;font-weight:900;font-size:1.18em;}
.theme-switch{font-size:1.13em;border:none;background:var(--card-space);padding:6px 16px;border-radius:10px;color:var(--accent);cursor:pointer;}
.layout-row{display:flex;}
.sidebar{width:205px;background:var(--bg-side);height:97vh;padding-top:17px;box-shadow:-1px 0 12px #191a2220;display:flex;flex-direction:column;gap:17px;align-items:flex-start;}
.logo{font-weight:900;color:var(--accent);font-size:1.17em;margin-bottom:28px;}
.menu-list{margin-bottom:22px;width:100%;}
.menu-btn{padding:12px 0;font-size:1.08em;color:var(--txt-sub);font-weight:900;border:none;width:100%;background:transparent;text-align:right;cursor:pointer;transition:.13s;font-family:'Tajawal',Arial,sans-serif;}
.menu-btn.active,.menu-btn:hover{color:var(--accent);}
.main-content{flex:1;padding:45px 4vw 45px 7vw;}
.section{display:none;}
.section.active{display:block;}
.section-title{color:var(--accent);font-weight:900;margin:0 0 17px 0;font-size:1.25em;}
.tasks-panel {
  background: var(--bg-task);
  border-radius: 17px;
  box-shadow: 0 2px 12px #1c257922;
  padding: 0 0 24px 0;
  max-width: 480px;
  margin: 38px auto 0 auto;
}
.tasks-list {padding: 0 23px;}
.add-task-bar {
  display: flex;
  align-items: center;
  gap: 7px;
  background: var(--bg-task);
  padding: 14px 18px 10px 18px;
}
.add-task-bar input[type="text"]{flex:1;padding:9px 10px;font-size:1.09em;border-radius:8px;border:1.2px solid #293848;background:var(--bg-side);color:var(--txt-main);}
.add-task-bar button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:.98em;}
.add-task-bar .opt-btn{background:transparent;color:var(--accent);border:none;font-size:1.25em;cursor:pointer;}
.adv-row{display:none;gap:6px;padding-top:9px;margin-bottom:6px;}
.adv-row select,.adv-row input{border-radius:7px;padding:5px 7px;font-size:.98em;border:1px solid #355;}
.task-row {
  display: flex;
  align-items: flex-start;
  gap: 13px;
  padding: 17px 0 14px 0;
  border-bottom: 1px solid #444b;
}
.task-row:last-child {border-bottom:none;}
.task-check {
  width: 25px; height: 25px; background: #232435;
  border-radius: 50%; border: 1.3px solid #2787ef33;
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.1s;
}
.task-check.checked{background:var(--accent);border-color:var(--accent);}
.task-check .material-icons {font-size:1.19em;}
.task-title {font-size:1.12em;font-weight:900;margin-bottom:5px;word-break:break-word;}
.task-title.done{ text-decoration: line-through; color: #788b95; }
.task-meta {
  color: var(--txt-sub); font-size: .98em; display: flex;
  gap: 7px; align-items: center; margin-bottom: 3px;
}
.task-actions button {
  background: #272a3a; color: var(--accent); border: none;
  padding: 2.5px 11px 2.5px 12px; border-radius: 8px; cursor: pointer;
  font-size: .96em; margin-left: 5px; font-family: 'Tajawal', Arial, sans-serif
}
.task-actions button.del {color: var(--prio-high);}
.task-actions button:active{background:var(--accent);color:#fff;}
.task-proj-label{display:inline-block;font-size:.97em;font-weight:800;padding:0 7px 0 7px;border-radius:8px;margin-left:4px;}
.task-proj-label.noproject{background:#888!important;color:#fff;}
.projects-board{max-width:900px;margin:22px auto 0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:24px;align-items:start;}
.project-card{background:var(--bg-task);border-radius:16px;box-shadow:0 2px 18px 1px #173a7335;padding:18px 15px 14px 19px;display:flex;flex-direction:column;align-items:flex-start;gap:9px;cursor:pointer;transition:.14s;position:relative;}
.project-card.active{box-shadow:0 0px 0px 3px var(--accent);}
.project-head{font-size:1.07em;font-weight:900;margin-bottom:4px;}
.project-label{display:inline-block;padding:2.2px 13px 4px 12px;border-radius:13px;font-size:1.07em;color:#fff;}
.project-desc{color:var(--txt-sub);padding-bottom:3px;}
.project-actions{margin-top:5px;}
.project-actions button{background:#232739;color:#52c2fc;border:none;padding:3px 15px 4px 15px;border-radius:7px;cursor:pointer;font-size:.97em;margin-left:3px;}
.project-actions button.del{color:#ef4444;}
.add-proj-board{max-width:420px;margin:auto;padding:14px 13px 13px 13px;background:var(--bg-task);border-radius:14px;box-shadow:0 2px 8px #173a7320;display:flex;flex-direction:column;gap:7px;}
.add-proj-form label{font-weight:bold;}
.add-proj-form input,.add-proj-form textarea,.add-proj-form select{border-radius:7px;border:1.1px solid #305;padding:8px 8px;font-size:1em;margin-bottom:7px;}
.add-proj-form{display:flex;flex-direction:column;gap:7px;}
.add-proj-form button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:9px 0;font-size:1.12em;cursor:pointer;width:fit-content;min-width:140px;}
.tracker-box {
  margin-top: -2px;
  background: var(--bg-task);
  border-radius: 0 0 16px 16px;
  box-shadow: 0 7px 33px #151f321a;
  padding: 18px 18px 16px 18px;
  font-family:'Tajawal',Arial,sans-serif;
  max-width: 98vw;
  border-top: 2px solid #314463;
  margin-bottom: 10px;
}
.tracker-header {display:flex; align-items:center; justify-content:space-between; padding-bottom:8px; border-bottom:1.5px solid #26334c; margin-bottom:11px;}
.tracker-header .track-title { font-size: 1.13em; font-weight: 900; color: var(--accent);}
.tracker-header .tracker-filter { background: #23283f; color: #52c2fc;border:none;border-radius:7px;font-size:.99em; font-family:'Tajawal',Arial,sans-serif;padding:7px 15px;}
.tracker-table {width:100%; border-spacing:0; border-collapse:separate; margin-bottom:5px; font-family:'Tajawal',Arial,sans-serif;}
.tracker-table th, .tracker-table td {padding:11px 9px;text-align:center;font-size:1.08em;}
.tracker-table th {background: #222432;color: #7ed6ff;font-weight: 900;font-size:1.02em;}
.tracker-table tr {border-radius:11px !important;transition: background 0.13s;}
.tracker-table tr:nth-child(even) {background: #252945;}
.tracker-table input, .tracker-table select, .tracker-table textarea {
  border-radius:7px; border:1.1px solid #355; padding:6px 13px; background:#232435; color:#fff; font-family:'Tajawal',Arial,sans-serif;}
.tracker-table .status-label {border-radius: 13px;font-size:.98em;font-weight:900;padding:5px 19px 7px 19px;display:inline-block;margin-top:7px;}
.tracker-table .status-moallaqa{background:#cfd9e2;color:#38384b;}
.tracker-table .status-motawaqqa{background:#236ce4;color:#fff;}
.tracker-table .status-tam{background:#23b267;color:#fff;}
.tracker-table .status-qeid{background:#b283ea;color:#fff;}
.tracker-table .status-a3tila{background:#ef4444;color:#fff;}
.tracker-table .status-molghaa{background:#676c7a;color:#fff;}
.tracker-table .delbtn{background:#262c44;color:#ef4444;border:none;border-radius:8px;padding:5px 13px;font-size:.97em;cursor:pointer;font-family:'Tajawal',Arial,sans-serif;}
.tracker-table .delbtn:hover{background:#ef4444;color:#fff;}
.tracker-op-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:9px 0;font-size:1.09em;cursor:pointer;width:fit-content;min-width:80px;font-family:'Tajawal',Arial,sans-serif;}
.tracker-add-inp, input[type="text"], textarea {text-align: right;}
#customModal {
  display:none;position:fixed;top:0;right:0;left:0;bottom:0;z-index:1200;background:rgba(25,27,40,.56);align-items:center;justify-content:center;
}
#customModal .modal-box {
  background:var(--bg-task);
  padding:33px 25px 25px 25px;
  border-radius:15px;min-width:250px;max-width:97vw;
  box-shadow:0 8px 38px #11226c99;
  display:flex;flex-direction:column;gap:13px;align-items:stretch;
}
#customModal input[type="text"] {
  width:100%;padding:10px 9px;border-radius:8px;border:1.2px solid #48508a;font-size:1.07em;background:#22283a;color:#fff;
}
#customModal button {font-family:'Tajawal',Arial,sans-serif;border:none;background:var(--accent);margin:0 0 0 7px;color:#fff;border-radius:8px;padding:6px 18px;font-size:1em;cursor:pointer;}
#customModal button.cancelBtn{background:#353b55;color:#fff;}
#customModal .modalBtnArea{display:flex;justify-content:flex-end;gap:9px;}
</style>
</head>
<body data-theme="dark">
<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹ØµØ±ÙŠ -->
<div id="customModal">
  <div class="modal-box">
    <span id="modalTitle" style="font-weight:900;font-size:1.15em;color:var(--accent);"></span>
    <input id="modalInput" type="text" autocomplete="off" maxlength="100">
    <div class="modalBtnArea">
      <button class="cancelBtn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="modalOkBtn">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>
</div>
<div class="header-app">
  <span>AliW | Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù…ÙŠ ÙˆÙ…Ø´Ø§Ø±ÙŠØ¹ÙŠ</span>
  <button class="theme-switch" onclick="toggleTheme()" id="themeToggle">ğŸŒ™</button>
</div>
<div class="layout-row">
  <div class="sidebar">
    <div class="logo">AliW</div>
    <div class="menu-list">
      <button class="menu-btn active" id="tasksMenuBtn" onclick="setSection('tasks')">Ø§Ù„Ù…Ù‡Ø§Ù…</button>
      <button class="menu-btn" id="projectsMenuBtn" onclick="setSection('projects')">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
    </div>
  </div>
  <div class="main-content">
    <!-- Ø§Ù„Ù…Ù‡Ø§Ù… -->
    <div class="section active" id="tasksSection">
      <div class="section-title">Ù…Ù‡Ø§Ù…ÙŠ (Google Tasks)</div>
      <div class="tasks-panel">
        <div class="add-task-bar">
          <input type="text" id="taskInput" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." maxlength="80">
          <button onclick="addTaskSimple()">Ø¥Ø¶Ø§ÙØ©</button>
          <button class="opt-btn" title="Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©" onclick="toggleAdvRow()"><span class="material-icons">expand_more</span></button>
        </div>
        <div class="adv-row" id="advRow">
          <select id="addProjId"></select>
          <input type="date" id="taskDue">
          <select id="taskPrio">
            <option value="high">Ù‡Ø§Ù…</option>
            <option value="med" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
            <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
          </select>
          <select id="taskRepeat">
            <option value="">ØªÙƒØ±Ø§Ø±</option>
            <option value="day">ÙŠÙˆÙ…ÙŠ</option>
            <option value="week">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
            <option value="month">Ø´Ù‡Ø±ÙŠ</option>
            <option value="year">Ø³Ù†ÙˆÙŠ</option>
          </select>
        </div>
        <div class="tasks-list" id="tasksList"></div>
      </div>
      <button class="archive-btn" onclick="showArchive()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</button>
      <div class="archive-section" id="archiveSection" style="display:none">
        <div class="archive-title">Ø§Ù„Ø£Ø±Ø´ÙŠÙ
          <button onclick="closeArchive()" style="float:left;background:var(--accent);color:white;border:0;padding:4px 15px 4px 15px;border-radius:7px;cursor:pointer;font-size:.93em;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="archive-list" id="archiveList"></div>
      </div>
    </div>
    <!-- Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
    <div class="section" id="projectsSection">
      <div class="section-title">ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ (Ø¨Ø·Ø§Ù‚Ø§Øª)</div>
      <div class="add-proj-board">
        <form class="add-proj-form" id="projAddForm" onsubmit="addProjectCard();return false;">
          <label for="projName">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
          <input type="text" id="projName" maxlength="28" required>
          <label for="projDesc">ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
          <textarea id="projDesc" maxlength="100" rows="2" required></textarea>
          <label for="projColor">Ù„ÙˆÙ† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
          <select id="projColor">
            <option value="#43b3fa" style="background:#43b3fa;color:#fff;">Ø£Ø²Ø±Ù‚</option>
            <option value="#ef4444" style="background:#ef4444;color:#fff;">Ø£Ø­Ù…Ø±</option>
            <option value="#fb8c00" style="background:#fb8c00;color:#fff;">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</option>
            <option value="#7d21ce" style="background:#7d21ce;color:#fff;">Ø¨Ù†ÙØ³Ø¬ÙŠ</option>
            <option value="#01bc82" style="background:#01bc82;color:#fff;">Ø£Ø®Ø¶Ø±</option>
            <option value="#f74d89" style="background:#f74d89;color:#fff;">ÙˆØ±Ø¯ÙŠ</option>
            <option value="#f28021" style="background:#f28021;color:#fff;">Ø°Ù‡Ø¨ÙŠ</option>
            <option value="#3d74ff" style="background:#3d74ff;color:#fff;">Ø³Ù…Ø§ÙˆÙŠ</option>
            <option value="#8f36c9" style="background:#8f36c9;color:#fff;">Ø¨Ù†ÙØ³Ø¬ÙŠ ØºØ§Ù…Ù‚</option>
            <option value="#41d6c3" style="background:#41d6c3;color:#222;">ØªØ±ÙƒÙˆØ§Ø²</option>
          </select>
          <button type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
        </form>
      </div>
      <div class="projects-board" id="projectsBoard"></div>
      <div id="projectTrackers"></div>
    </div>
  </div>
</div>
<script>
/* Ù…ÙˆØ¯Ø§Ù„ Ø¹ØµØ±ÙŠ */
let modalCallback = null;
function showModal(title, value, okCallback) {
  document.getElementById("modalTitle").innerText = title;
  document.getElementById("modalInput").value = value || "";
  document.getElementById("customModal").style.display = "flex";
  modalCallback = okCallback;
  setTimeout(()=>{document.getElementById("modalInput").focus();},60)
}
function closeModal(){
  document.getElementById("customModal").style.display = "none";
  modalCallback=null;
}
document.getElementById("modalOkBtn").onclick = function() {
  if(modalCallback) modalCallback(document.getElementById("modalInput").value);
  closeModal();
};
document.getElementById("customModal").onclick = function(e){
  if(e.target==this) closeModal();
}
document.getElementById("modalInput").onkeydown = function(e){
  if(e.key==="Enter"){document.getElementById("modalOkBtn").click();}
}

/* Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
let tasks = JSON.parse(localStorage.getItem("projTasks_tasks")||'[]');
let projectsExtra = JSON.parse(localStorage.getItem("projTasks_extracard")||'[]');
let openProjectId = null;

/* ========== Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ========== */
function renderProjectsCards(){
  const board=document.getElementById("projectsBoard");
  if(!projectsExtra.length){
    board.innerHTML="<div style='color:var(--txt-sub);padding:35px 0;text-align:center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯.</div>";
    document.getElementById("projectTrackers").innerHTML="";
    return;
  }
  board.innerHTML=projectsExtra.map((p,i)=>
    `<div class="project-card${openProjectId===p.id?' active':''}" onclick="toggleProjectTracker(${p.id})">
      <div class="project-head"><span class="project-label" style="background:${p.color};">${p.title}</span></div>
      <div class="project-desc">${p.desc}</div>
      <div class="project-actions">
        <button onclick="event.stopPropagation();editProjectCard(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="event.stopPropagation();delProjectCard(${i})" class="del">Ø­Ø°Ù</button>
      </div>
    </div>`
  ).join("");
  renderProjectTrackers();
}
function toggleProjectTracker(projId){
  openProjectId = (openProjectId===projId ? null : projId);
  renderProjectsCards();
}
function renderProjectTrackers(){ // Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙÙ‚Ø· - Ø¯ÙØªØ± Ø§Ù„ØªØªØ¨Ø¹
  let box = document.getElementById("projectTrackers");
  if(!openProjectId){box.innerHTML="";return;}
  let curProj = projectsExtra.find(p=>p.id===openProjectId);
  if(!curProj){box.innerHTML="";return;}
  let tracker = JSON.parse(localStorage.getItem("projTrack_"+openProjectId) || "[]");
  let filt = localStorage.getItem("projTrackFilt_"+openProjectId)||"";
  let trackStatusOpts = [
    {val:"Ù…Ø¹Ù„Ù‚Ø©",lbl:"Ù…Ø¹Ù„Ù‚Ø©",cls:"status-moallaqa"},
    {val:"Ù…ØªÙˆÙ‚Ø¹Ø©",lbl:"Ù…ØªÙˆÙ‚Ø¹Ø©",cls:"status-motawaqqa"},
    {val:"ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²",lbl:"ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²",cls:"status-tam"},
    {val:"Ø¹Ø§Ø·Ù„Ø©",lbl:"Ø¹Ø§Ø·Ù„Ø©",cls:"status-a3tila"},
    {val:"Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²",lbl:"Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²",cls:"status-qeid"},
    {val:"Ù…Ù„ØºØ§Ø©",lbl:"Ù…Ù„ØºØ§Ø©",cls:"status-molghaa"}
  ];
  let filtered = (filt&&filt!=="") ? tracker.filter(e=>e.status===filt) : tracker;
  box.innerHTML = `
    <div class="tracker-box">
      <div class="tracker-header">
        <span class="track-title">Ø¯ÙØªØ± ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span>
        <span>
          <label>ÙÙ„ØªØ±Ø©:</label>
          <select class="tracker-filter" onchange="setProjFilter(${openProjectId},this.value)">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            ${trackStatusOpts.map(opt=>`<option value="${opt.val}" ${filt===opt.val?'selected':''}>${opt.lbl}</option>`).join('')}
          </select>
        </span>
      </div>
      <div style="overflow-x:auto">
      <table class="tracker-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ù‡Ù…Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        ${filtered.map((row,idx)=>`
        <tr>
          <td><span>${row.title}</span></td>
          <td>
            <select onchange="trackStatusChange(${openProjectId},${idx},this.value)" style="font-weight:900;">
              ${trackStatusOpts.map(opt=>`<option value="${opt.val}" ${opt.val===row.status?'selected':''}>${opt.lbl}</option>`).join('')}
            </select>
            <span class="status-label ${trackStatusOpts.find(o=>o.val==row.status)?.cls||'status-moallaqa'}">${row.status}</span>
          </td>
          <td><span>${row.note||""}</span></td>
          <td><span>${row.date||""}</span></td>
          <td>
            <button class="delbtn" onclick="deleteTrackRow(${openProjectId},${idx});event.stopPropagation();">Ø­Ø°Ù</button>
          </td>
        </tr>
        `).join("")}
        <!-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ -->
        <tr>
          <td><input type="text" id="trackNewTitle" placeholder="Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." class="tracker-add-inp"></td>
          <td>
            <select id="trackNewStatus">
              ${trackStatusOpts.map(opt=>`<option value="${opt.val}" ${opt.val==="Ù…Ø¹Ù„Ù‚Ø©"?'selected':''}>${opt.lbl}</option>`).join('')}
            </select>
            <span class="status-label status-moallaqa">Ù…Ø¹Ù„Ù‚Ø©</span>
          </td>
          <td><input type="text" id="trackNewNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></td>
          <td>-</td>
          <td>
            <button class="tracker-op-btn" onclick="addTrackRow(${openProjectId});event.stopPropagation();">Ø¥Ø¶Ø§ÙØ©</button>
          </td>
        </tr>
        </tbody>
      </table>
      </div>
    </div>`;
  let sel=document.getElementById('trackNewStatus');
  if(sel){
    sel.onchange=function(){
      let s=this.value;
      let span=this.parentNode.querySelector('.status-label');
      let c=trackStatusOpts.find(o=>o.val==s)?.cls||'status-moallaqa';
      span.className="status-label "+c; span.innerHTML=s;
    };
  }
}
function setProjFilter(pid,val){
  localStorage.setItem("projTrackFilt_"+pid,val);
  renderProjectTrackers();
}
function addTrackRow(pid){
  let track=JSON.parse(localStorage.getItem("projTrack_"+pid) || "[]");
  let title = document.getElementById("trackNewTitle").value.trim();
  let status = document.getElementById("trackNewStatus").value;
  let note = document.getElementById("trackNewNote").value.trim();
  if(!title)return;
  let date=new Date().toISOString().slice(0,10);
  track.push({title,status,note,date});
  localStorage.setItem("projTrack_"+pid,JSON.stringify(track));
  renderProjectTrackers();
}
function deleteTrackRow(pid,idx){
  let track=JSON.parse(localStorage.getItem("projTrack_"+pid) || "[]");
  track.splice(idx,1);
  localStorage.setItem("projTrack_"+pid,JSON.stringify(track));
  renderProjectTrackers();
}
function trackStatusChange(pid,idx,newVal){
  let track=JSON.parse(localStorage.getItem("projTrack_"+pid) || "[]");
  track[idx].status=newVal;
  localStorage.setItem("projTrack_"+pid,JSON.stringify(track));
  renderProjectTrackers();
}
function addProjectCard(){
  let name=document.getElementById("projName").value.trim();
  let desc=document.getElementById("projDesc").value.trim();
  let color=document.getElementById("projColor").value;
  if(!name||!desc)return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ + ÙˆØµÙÙ‡");
  projectsExtra.push({id:Date.now(),title:name,desc,color});
  localStorage.setItem("projTasks_extracard",JSON.stringify(projectsExtra));
  document.getElementById("projName").value="";
  document.getElementById("projDesc").value="";
  document.getElementById("projColor").value="#43b3fa";
  renderProjectsCards();
}
function delProjectCard(i){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ"))return;
  let id = projectsExtra[i].id;
  projectsExtra.splice(i,1);
  localStorage.setItem("projTasks_extracard",JSON.stringify(projectsExtra));
  localStorage.removeItem("projTrack_"+id);
  localStorage.removeItem("projTrackFilt_"+id);
  openProjectId = null;
  renderProjectsCards();
}
function editProjectCard(i){
  let proj=projectsExtra[i];
  showModal("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:", proj.title, (newTitle)=>{
    if(newTitle!=null && newTitle.trim()){
      projectsExtra[i]={...proj,title:newTitle};
      localStorage.setItem("projTasks_extracard",JSON.stringify(projectsExtra));
      renderProjectsCards();
    }
  });
}
function renderProjectDropdown(){
  let sel=document.getElementById("addProjId");
  if(!sel) return;
  sel.innerHTML = `<option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±ÙˆØ¹</option>` +
    projectsExtra.map(p=>`<option value="${p.id}" style="background:${p.color};color:#fff">${p.title}</option>`).join('');
}

/* ========== Ø§Ù„Ù…Ù‡Ø§Ù… ========== */
function renderTaskList(){
  document.getElementById("archiveSection").style.display="none";
  let list=document.getElementById("tasksList");
  let all=tasks.filter(t=>!t.done);
  let scheduled=all.filter(t=>t.due).sort((a,b)=>a.due.localeCompare(b.due));
  let unscheduled=all.filter(t=>!t.due);
  let merged=scheduled.concat(unscheduled);
  if(!merged.length) {list.innerHTML ='<div style="color:var(--txt-sub);padding:33px 0;text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</div>'; return;}
  list.innerHTML=merged.map((t,i)=>{
    let idx=tasks.indexOf(t);
    return `<div class="task-row">
      <div class="task-check${t.done?' checked':''}" onclick="toggleDone(${idx})"><span class="material-icons">${t.done?'check':'radio_button_unchecked'}</span></div>
      <div class="task-info">
        <div class="task-title${t.done?' done':''}">${t.title} ${projLabel(t.projId)}</div>
        <div class="task-meta">
          ${t.due?`<span><span class="material-icons" style="font-size:1em;vertical-align:middle">event</span> ${t.due}</span>`:""}
          ${t.repeat&&!t.done?`<span><span class="material-icons" style="font-size:1em;vertical-align:middle">repeat</span> ${t.repeat}</span>`:""}
          <span class="task-prio ${t.prio}">${prioLabel(t.prio)}</span>
        </div>
        <div class="task-actions">
          <button onclick="editTask(${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="delTask(${idx})" class="del">Ø­Ø°Ù</button>
        </div>
      </div>
    </div>`
  }).join('');
}
function addTaskSimple(){
  let title=document.getElementById("taskInput").value.trim();
  let projId=document.getElementById("addProjId").value;
  if(projId==="") projId = null;
  let prio=(document.getElementById("taskPrio")?.value)||"med";
  let due=(document.getElementById("taskDue")?.value)||"";
  let repeat=(document.getElementById("taskRepeat")?.value)||"";
  if(!title)return;
  tasks.push({id:Date.now(),projId,title,done:false,prio,due,repeat});
  localStorage.setItem("projTasks_tasks",JSON.stringify(tasks));
  document.getElementById("taskInput").value="";
  document.getElementById("advRow").style.display="none";
  renderTaskList();
}
function editTask(i){
  let t=tasks[i];
  showModal("ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø©:",t.title,(newTitle)=>{
    if(newTitle!=null&&newTitle.trim()){
      t.title=newTitle.trim();
      localStorage.setItem("projTasks_tasks",JSON.stringify(tasks));
      renderTaskList();
    }
  });
}
function delTask(i){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ"))return;
  tasks.splice(i,1);
  localStorage.setItem("projTasks_tasks",JSON.stringify(tasks));
  renderTaskList();
}
function toggleDone(i){
  tasks[i].done=!tasks[i].done;
  localStorage.setItem("projTasks_tasks",JSON.stringify(tasks));
  renderTaskList();
}
function projLabel(id){
  if(!id){ return '<span class="task-proj-label noproject">Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±ÙˆØ¹</span>'; }
  let proj=projectsExtra.find(x=>x.id==id);
  if(!proj){ return '<span class="task-proj-label noproject">Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±ÙˆØ¹</span>'; }
  return `<span class="task-proj-label" style="background:${proj.color||'#888'};color:#fff">${proj.title}</span>`;
}
function prioLabel(p){
  if(p=="high")return"Ù‡Ø§Ù…";
  if(p=="med")return"Ù…ØªÙˆØ³Ø·";
  return"Ù…Ù†Ø®ÙØ¶";
}
function showArchive(){
  document.getElementById("archiveSection").style.display="block";
  let arch=tasks.filter(t=>t.done);
  let arcCont=document.getElementById("archiveList");
  if(!arch.length){
    arcCont.innerHTML='<div style="color:var(--txt-sub);padding:14px 0;text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ù†Ø¬Ø²Ø©</div>';return;
  }
  arcCont.innerHTML=arch.map((t,i)=>{
    let idx=tasks.indexOf(t);
    return `<div class="task-row archive-row">
      <div class="task-info">
        <div class="task-title done">${t.title} ${projLabel(t.projId)}</div>
        <div class="task-meta">
          ${t.due?`<span><span class="material-icons" style="font-size:1em;vertical-align:middle">event</span> ${t.due}</span>`:""}
          ${t.repeat?`<span><span class="material-icons" style="font-size:1em;vertical-align:middle">repeat</span> ${t.repeat}</span>`:""}
          <span class="task-prio ${t.prio}">${prioLabel(t.prio)}</span>
        </div>
        <div class="archive-actions">
          <button onclick="unarchiveTask(${idx})" style="background:var(--accent);color:#fff;padding:3px 11px 3px 11px;border:0;border-radius:7px;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
          <button onclick="delTask(${idx})" class="del" style="margin-left:7px;">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
      </div>
    </div>`
  }).join('');
}
function closeArchive(){
  document.getElementById("archiveSection").style.display="none";
  renderTaskList();
}
function unarchiveTask(i){
  tasks[i].done=false;
  localStorage.setItem("projTasks_tasks",JSON.stringify(tasks));
  showArchive();
}

/* Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ */
function toggleAdvRow(){
  let adv=document.getElementById("advRow");
  adv.style.display=(adv.style.display=="flex"?"none":"flex");
  renderProjectDropdown();
}
function setSection(sec) {
  document.getElementById('tasksSection').classList.remove('active');
  document.getElementById('projectsSection').classList.remove('active');
  document.getElementById('calendarSection')?.classList.remove('active');
  document.getElementById('tasksMenuBtn').classList.remove('active');
  document.getElementById('projectsMenuBtn').classList.remove('active');
  document.getElementById('calendarMenuBtn')?.classList.remove('active'); // Ø²Ø± Ø§Ù„ØªÙ‚ÙˆÙŠÙ…

  if (sec == "tasks") {
    document.getElementById('tasksSection').classList.add('active');
    document.getElementById('tasksMenuBtn').classList.add('active');
    renderTaskList();
    return;
  }
  if (sec == "projects") {
    document.getElementById('projectsSection').classList.add('active');
    document.getElementById('projectsMenuBtn').classList.add('active');
    renderProjectsCards();
    return;
  }
  if (sec == "calendar") {
    document.getElementById('calendarSection').classList.add('active');
    document.getElementById('calendarMenuBtn').classList.add('active');
    renderCalendar();
    return;
  }
}
function toggleTheme(){
  let th=document.body.dataset.theme=="dark"?"light":"dark";
  document.body.dataset.theme=th;
  document.getElementById("themeToggle").textContent=th=="dark"?"â˜€ï¸":"ğŸŒ™";
  localStorage.setItem("theme_mode",th);
}
document.body.dataset.theme = localStorage.getItem("theme_mode")||"dark";
document.getElementById("themeToggle").textContent = document.body.dataset.theme=="dark"?"â˜€ï¸":"ğŸŒ™";
/* Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ */
renderProjectsCards();renderProjectDropdown();renderTaskList();
// Ù‚Ø³Ù… Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
let calendarEvents = JSON.parse(localStorage.getItem("projTasks_calendar")||'[]');

function renderCalendar(month, year) {
  let today = new Date();
  let m = (typeof month === "number") ? month : today.getMonth();
  let y = (typeof year === "number") ? year : today.getFullYear();

  let firstDay = new Date(y, m, 1).getDay();
  let daysInMonth = new Date(y, m+1, 0).getDate();
  let weekDays = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];

  // ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø£ÙŠØ§Ù…
  let calHeader = '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:7px;font-weight:900;color:#61c9ff;background:#181922;border-radius:9px;margin-bottom:4px;">' +
    weekDays.map(d=>'<div style="padding:6px 0;text-align:center">'+d+'</div>').join('') +
    '</div>';
  document.getElementById("calendarHeader").innerHTML = calHeader;

  let grid = '';
  let dt = 1;
  let todayStr = today.toISOString().slice(0,10);
  let monthTasks = tasks.concat([]).filter(t => t.due && t.due.startsWith(`${y}-${String(m+1).padStart(2,"0")}`) && !t.done);

  for (let i=0; i<6; i++) {
    for (let j=0; j<7; j++) {
      let cell = '';
      let dayNum = (i===0 && j<((firstDay+6)%7)) ? '' : (dt <= daysInMonth ? dt : '');
      let dateStr = '';
      if (dayNum) {
        dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
        cell += `<div class="cal-date-num">${dayNum}</div>`;
        // Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        calendarEvents.filter(ev=>ev.date===dateStr)
        .forEach((ev,idx)=>{
          cell += `<span class="cal-appt" onclick="editAppt(${idx})">${ev.title} ${ev.from?`<span style='font-size:.92em;'>${ev.from}${ev.to?'-'+ev.to:""}</span>`:""}</span>`;
        });
        // Ø§Ù„Ù…Ù‡Ø§Ù… Ø­Ø³Ø¨ Ù…ÙˆØ¹Ø¯Ù‡Ø§
        monthTasks.filter(t=>t.due===dateStr).forEach(t=>{
          cell += `<span class="cal-task">${t.title}</span>`;
        });
      }
      grid += `<div class="calendar-day${dayNum&&dateStr===todayStr?' today':''}">${cell||""}</div>`;
      if (dayNum) dt++;
    }
  }
  document.getElementById("calendarGrid").innerHTML = grid;
}

// Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…:
function showEventModal(evIdx=-1) {
  document.getElementById("calendarModal").style.display = "flex";
  if(evIdx === -1) {
    document.getElementById("calModalTitle").innerText = "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯";
    document.getElementById("calEventTitle").value = "";
    document.getElementById("calEventDate").value = "";
    document.getElementById("calEventFrom").value = "";
    document.getElementById("calEventTo").value = "";
    document.getElementById("calModalOkBtn").onclick = function() {
      let title = document.getElementById("calEventTitle").value.trim();
      let date = document.getElementById("calEventDate").value;
      let from = document.getElementById("calEventFrom").value;
      let to = document.getElementById("calEventTo").value;
      if(!title||!date) return;
      calendarEvents.push({title,date,from,to});
      localStorage.setItem("projTasks_calendar",JSON.stringify(calendarEvents));
      closeEventModal();
      renderCalendar();
    };
  } else {
    let ev = calendarEvents[evIdx];
    document.getElementById("calModalTitle").innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯";
    document.getElementById("calEventTitle").value = ev.title;
    document.getElementById("calEventDate").value = ev.date;
    document.getElementById("calEventFrom").value = ev.from||"";
    document.getElementById("calEventTo").value = ev.to||"";
    document.getElementById("calModalOkBtn").onclick = function() {
      let title = document.getElementById("calEventTitle").value.trim();
      let date = document.getElementById("calEventDate").value;
      let from = document.getElementById("calEventFrom").value;
      let to = document.getElementById("calEventTo").value;
      if(!title||!date) return;
      calendarEvents[evIdx] = {title,date,from,to};
      localStorage.setItem("projTasks_calendar",JSON.stringify(calendarEvents));
      closeEventModal();
      renderCalendar();
    };
  }
}
function editAppt(idx){ showEventModal(idx); }
function closeEventModal(){ document.getElementById("calendarModal").style.display = "none"; }

// Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
const calendarMenuBtn = document.createElement("button");
calendarMenuBtn.className = "menu-btn";
calendarMenuBtn.id = "calendarMenuBtn";
calendarMenuBtn.innerText = "Ø§Ù„ØªÙ‚ÙˆÙŠÙ…";
calendarMenuBtn.onclick = ()=>setSection('calendar');
document.querySelector(".menu-list").appendChild(calendarMenuBtn);

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
const oldSetSection = setSection;
setSection = function(sec){
  oldSetSection(sec);
  if(sec=="calendar"){ renderCalendar(); }
}
</script>
</body>
</html>
